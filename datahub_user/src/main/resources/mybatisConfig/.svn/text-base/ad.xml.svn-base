<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- LLBTMP_ADVERTISEMENT:广告表 -->
<mapper namespace="ad">
  <resultMap id="adMap" type="_Ad">
    <id property="id" column="id" />
    <result property="startTime" column="start_time" jdbcType ="DATE" />
    <result property="endTime" column="end_time" />
    <result property="resourceId" column="resource_id"  />
    <result property="picture" column="picture" jdbcType="BLOB" />
    <result property="clickCount" column="click_count"  />
    <result property="sequence" column="sequence"  />
    <result property="remark" column="remark"  />
    <result property="adContent" column="adContent"  />
    <result property="operateType" column="operate_type"  />
    <result property="dealStatus" column="deal_status"  />
    <result property="runStatus" column="run_status"  />
    <result property="target" column="target"  />
    <result property="submitDate" column="submit_date"  />
    <result property="reviewDate" column="review_date"  />
    <result property="explain" column="explain"  />
    <result property="adType" column="ad_type"  />
    <result property="buttonText" column="buttonText"  />
  </resultMap>
  <resultMap id="adMap2" type="_Ad"  extends="adMap">  
    <association property="branch" column="branch" select="getBranch"></association>
    <association property="channel" column="channel" select="getChannel"></association>
    <association property="adPos" column="ad_pos" select="getAdPos"></association>
    <association property="operator" column="operator_id" select="getOperator"></association>
    <association property="reviewer" column="reviewer_id" select="getReviewer"></association>
  </resultMap>
  <select id="getChannel" parameterType="int" resultType="_Channel">
	select id,channel_name channelName from llbtmp_channel where id = #{xxx}
  </select>
  <select id="getBranch" resultType="_Branch">
	select id,branch_name branchName,branch_code branchCode,region,REGION_EN gegionEn from llbtmp_branch where id = #{xxx}     
  </select>
  <select id="getAdPos" resultType="_AdPosition">
	select id,position,MAX_COUNT maxCount from llbtmp_ad_position where id = #{xxx}
  </select>
  <select id="getOperator" resultType="_SessionVo">
	select * from llbtmp_admin where id = #{xxx}
  </select>
  <select id="getReviewer" resultType="_SessionVo">
	select * from llbtmp_admin where id = #{xxx}
  </select>
	
	<!-- 公共sql提取  -->
	<sql id="querySql">
        <if test="channel != null">  and (M.channel = #{channel} ) </if>
        <if test="adPos != null">  and (M.ad_pos = #{adPos} ) </if>
        <if test="branch != null">  and (M.branch = #{branch} ) </if>
        <if test="dealStatus != null">  and (M.deal_status = #{dealStatus} ) </if>
	</sql>
    <sql id="querySqlDim">
        <if test="channel != null and channel != '' ">  and (M.channel like '%'||#{channel}||'%' ) </if>
        <if test="adPos != null and adPos != '' ">  and (M.ad_pos like '%'||#{adPos}||'%' ) </if>
        <if test="branch != null and branch != '' ">  and (M.branch like '%'||#{branch}||'%' ) </if>
        <if test="dealStatus != null and dealStatus != '' ">  and (M.deal_status like '%'||#{dealStatus}||'%' ) </if>
	</sql>  

	<insert id="addAd" parameterType="_Ad">
	  insert into LLBTMP_AD(id,start_time,end_time,adContent,ad_type,ad_pos,channel,branch,operate_type,deal_status,submit_date,operator_id,picture,resource_id) 
	  values(#{id},to_date(#{startTime,jdbcType=DATE},'yyyy-mm-dd hh24:mi:ss'),to_date(#{endTime},'yyyy-mm-dd hh24:mi:ss'),
	  #{adContent},#{adType},#{adPos.id},#{channel.id},#{branch.id},#{operateType},#{dealStatus},to_date(#{submitDate},'yyyy-mm-dd hh24:mi:ss'),
	  #{operator.id,jdbcType=INTEGER},empty_blob(),#{resourceId,jdbcType=BIGINT})
	</insert> 
	
	<select id="queryTheAd" parameterType="_Ad" resultMap="adMap">
	  select * from llbtmp_ad where channel=#{channel.id} and ad_pos=#{adPos.id} and branch=#{branch.id} 
	</select>
	
	
	
	<select id="getAdById" parameterType="long" resultType="_Ad">
	  select * from llbtmp_ad where id = #{aa} for update
	</select>
	
   <select id="getAllAd" resultMap="adMap2">
     select * from llbtmp_ad
   </select>
   
   <select id="getAdDetail" parameterType="long" resultMap="adMap2">
     select * from llbtmp_ad where id=#{id}
   </select>
  
   <update id="updAdDel" parameterType="_Ad" >
     update llbtmp_ad set operate_type = #{operateType}, operator_id=#{operator.id},
     submit_date=to_date(#{submitDate},'yyyy-mm-dd hh24:mi:ss'),deal_status=#{dealStatus}
     where id = #{id}
   </update>
   <select id="selectAdAmount" resultType="int" parameterType="java.util.Map">
     select count(*) from llbtmp_ad m where 1 = 1 and run_status is null
     <include refid="querySql"/>
   </select>
   <select id="selectRunAdAmount" resultType="int" parameterType="java.util.Map">
     select count(*) from llbtmp_ad m where 1 = 1 and run_status = 'R'
     <include refid="querySql"/>
   </select>
   <select id="selectNowRunAdAmount" resultType="int" parameterType="java.util.Map">
     select count(*) from llbtmp_ad m where 1 = 1 and run_status = 'R' and 
     <![CDATA[
     start_time <= to_date(#{nowtime},'yyyy-mm-dd hh24:mi:ss') and end_time > to_date(#{nowtime},'yyyy-mm-dd hh24:mi:ss')
     ]]>
     <include refid="querySql"/>
   </select>
    <!-- 根据条件分页查询(可运行的广告信息)信息  -->
   <select id="select_now_runAd_withPage" parameterType="java.util.Map" resultMap="adMap2" >
	SELECT * FROM (
	SELECT MYROW.*, ROWNUM RN 
	FROM (
      select * from llbtmp_ad m where 1 = 1 and run_status = 'R' and 
      <![CDATA[
        start_time <= to_date(#{nowtime},'yyyy-mm-dd hh24:mi:ss') and end_time > to_date(#{nowtime},'yyyy-mm-dd hh24:mi:ss')
      ]]>
      <include refid="querySql"/> 
	     ) MYROW  <![CDATA[
		WHERE ROWNUM <= #{_end}
		) 
		WHERE RN >= #{_begin}]]>
		ORDER BY ID DESC
   </select>
   <!-- 根据条件分页查询(广告信息)信息  -->
   <select id="select_ad_withPage" parameterType="java.util.Map" resultMap="adMap2" >
	SELECT * FROM (
	SELECT MYROW.*, ROWNUM RN 
	FROM (
      select * from llbtmp_ad m where 1 = 1
	  <include refid="querySql"/> and run_status is null
	     ) MYROW  <![CDATA[
		WHERE ROWNUM <= #{_end}
		) 
		WHERE RN >= #{_begin}]]>
		ORDER BY ID DESC
   </select>
   <!-- 根据条件分页查询(可运行的广告信息)信息  -->
   <select id="select_runAd_withPage" parameterType="java.util.Map" resultMap="adMap2" >
	SELECT * FROM (
	SELECT MYROW.*, ROWNUM RN 
	FROM (
      select * from llbtmp_ad m where 1 = 1
	  <include refid="querySql"/> and run_status = 'R'
	     ) MYROW  <![CDATA[
		WHERE ROWNUM <= #{_end}
		) 
		WHERE RN >= #{_begin}]]>
		ORDER BY ID DESC
   </select>
  
   <delete id="delAdById" parameterType="long">
     delete from llbtmp_ad where id = #{target}
   </delete>
   <insert id="adOneAd" parameterType="java.util.Map">
     insert into LLBTMP_AD
	(
	  id,        
	  START_TIME ,
	  END_TIME    ,
	  BRANCH   ,   
	  CHANNEL  ,  
	  RESOURCE_ID ,
	  AD_POS     , 
	  PICTURE    , 
	  CLICK_COUNT ,
	  SEQUENCE    ,
	  adContent  ,
	  EXPLAIN ,   
	  REMARK,      
	  OPERATE_TYPE, 
	  DEAL_STATUS ,
	  TARGET,      
	  OPERATOR_ID ,
	  REVIEWER_ID, 
	  SUBMIT_DATE ,
	  REVIEW_DATE, 
	  AD_TYPE ,    
	  BUTTONTEXT
	
	) 
	select   
	  #{idNew},        
	  START_TIME ,
	  END_TIME    ,
	  BRANCH   ,   
	  CHANNEL  ,  
	  RESOURCE_ID ,
	  AD_POS     , 
	  PICTURE    , 
	  CLICK_COUNT ,
	  SEQUENCE    ,
	  adContent  ,
	  EXPLAIN ,   
	  REMARK,      
	  OPERATE_TYPE, 
	  DEAL_STATUS ,
	  TARGET,      
	  OPERATOR_ID ,
	  REVIEWER_ID, 
	  SUBMIT_DATE ,
	  REVIEW_DATE, 
	  AD_TYPE ,    
	  BUTTONTEXT from LLBTMP_AD where id = #{idOld}
   </insert>
   <update id="updateNewAd1" parameterType="_Ad" >
     update llbtmp_ad set 
     target=#{target},run_status=#{runStatus,jdbcType=VARCHAR}
     where id = #{id}
   </update>
    <update id="updateNewAd" parameterType="_Ad" >
     update llbtmp_ad set adContent = #{adContent},operate_type = #{operateType}, operator_id=#{operator.id},
     submit_date=to_date(#{submitDate},'yyyy-mm-dd hh24:mi:ss'),deal_status=#{dealStatus}
     where id = #{id}
   </update>
   <update id="updateOldAd" parameterType="_Ad">
     update llbtmp_ad set deal_status=#{dealStatus}, operate_type=#{operateType},operator_id=#{operator.id},submit_date=to_date(#{submitDate},'yyyy-mm-dd hh24:mi:ss') 
     where id = #{id}
   </update>
   <update id="checkAdAbled" parameterType="_Ad">
     update llbtmp_ad set deal_status=#{dealStatus},reviewer_id=#{reviewer.id},review_date=to_date(#{reviewDate},'yyyy-mm-dd hh24:mi:ss'),
     run_status=#{runStatus} 
     where id = #{id}     
   </update>
    <update id="checkAdDisabled" parameterType="_Ad">
     update llbtmp_ad set deal_status=#{dealStatus},reviewer_id=#{reviewer.id},review_date=to_date(#{reviewDate},'yyyy-mm-dd hh24:mi:ss')
     where id = #{id}     
   </update>
   <update id="updAd2" parameterType="_Ad" >
     update llbtmp_ad set adContent = #{adContent},operate_type = #{operateType}, operator_id=#{operator.id},
     submit_date=to_date(#{submitDate},'yyyy-mm-dd hh24:mi:ss'),deal_status=#{dealStatus}
     where id = #{id}
   </update>
   
	
	
	
	
	
	


</mapper>