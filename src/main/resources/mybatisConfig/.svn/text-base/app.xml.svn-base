<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!-- LLBTMP_APP:应用表 -->
<mapper namespace="app">
  <resultMap id="appMap" type="_App">
  	<!-- 应用编号 -->
    <id property="id" column="id" />
    <!-- 入口类名 -->
    <result property="appEntrance" column="app_entrance"  />
    <!-- 入口包名-->
    <result property="appPackage" column="app_package"  />
    <!-- 应用描述内容(包括更新说明) -->
    <result property="details" column="details"  />
    <!-- 应用下载次数 -->
    <result property="downloadCount" column="download_count"  />
    <!--结束时间  -->
    <result property="endTime" column="end_time"  />
    <!-- 关键字 -->
    <result property="keywords" column="keywords"  />
    <!--应用图标  -->
    <result property="icon" column="icon"  />
    <!-- 应用名称 -->
    <result property="name" column="name"  />
    <!--1分评分数量  -->
    <result property="point1" column="point1"  />
    <!--2分评分数量  -->
    <result property="point2" column="point2"  />
    <!--3分评分数量  -->
    <result property="point3" column="point3"  />
    <!--4分评分数量  -->
    <result property="point4" column="point4"  />
    <!--5分评分数量  -->
    <result property="point5" column="point5"  />
    <!--应用产品号  -->
    <result property="product" column="product"  />
    <!-- 应用大小 -->
    <result property="packageSize" column="package_size"  />
    <!--应用大小  -->
    <result property="startTime" column="start_time"  />
    <!-- 操作类型 -->
    <result property="operateType" column="operate_type"  />
    <!-- 操作状态 -->
    <result property="dealStatus" column="deal_status"  />
    <!-- 应用简介 -->
    <result property="synopsis" column="synopsis"  />
    <!--目标记录， 添加记录时该值为空  -->
    <result property="target" column="target"  />
    <!--应用种类  -->
    <result property="typeId" column="type_id"  />
    <!--应用的下载地址  -->
    <result property="url" column="url"  />
    <!-- 应用版本号 -->
    <result property="version" column="version"  />
    <!--版本信息  -->
    <result property="versionInfo" column="version_info"  />
    <!-- 应用发布机构 -->
    <result property="branchId" column="branch_id"  />
    <!-- 渠道 -->
     <result property="channels" column="channels"  />
    
    <!-- 分享次数 -->
    <result property="shareCount" column="share_count"  />
    <!--提交复核的业务员  -->
    <result property="operatorId" column="operator_id"  />
    <!--上次复核操作的复核人员    -->
    <result property="reviewerId" column="reviewer_id"  />
    <!-- 提交复核的时间 -->
    <result property="submitDate" column="submit_date"  />
    <!-- 上次复核操作的时间 -->
    <result property="reviewDate" column="review_date"  />
    <!-- 运行状态 -->
    <result property="runStatus" column="run_status"  />
	</resultMap>
	
	<resultMap id="appMap2" type="_App">
  	<!-- 应用编号 -->
    <id property="id" column="id" />
    <!-- 应用名称 -->
    <result property="name" column="name"  />
    <!--应用产品号  -->
    <result property="product" column="product"  />
    <!-- 应用大小 -->
    <result property="packageSize" column="package_size"  />
    <!-- 应用简介 -->
    <result property="synopsis" column="synopsis"  />
    <!-- 应用版本号 -->
    <result property="version" column="version"  />
    <!--版本信息  -->
    <result property="versionInfo" column="version_info"  />
	</resultMap>
	
	<sql id="querySqlDim">
        <if test="branchId != null and branchId != '' ">  and (B.BRANCH_ID like '%'||#{branchId}||'%' ) </if>
	</sql>
	<sql id="querySqlDim2">
        <if test="product != null and product != '' ">  and (m.product like '%'||#{product}||'%' ) </if>
        <if test="name != null and name != '' ">  and (m.name like '%'||#{name}||'%' ) </if>
	</sql>
    
    <select id="getSomeAppAmount" parameterType="Map" resultType="int">
      select count(*) from llbtmp_app m where 1=1 and run_status = 'R'
      <include refid="querySqlDim2"/>
    </select>
      <!-- 根据条件分页查询信息(应用)  -->
   <select id="select_app_withPage" parameterType="java.util.Map" resultMap="appMap" >
	SELECT * FROM (
	SELECT MYROW.*, ROWNUM RN 
	FROM (
      select * from llbtmp_app m where 1 = 1 and run_status = 'R'
	  <include refid="querySqlDim2"/> 
	     ) MYROW  <![CDATA[
		WHERE ROWNUM <= #{_end}
		) 
		WHERE RN >= #{_begin}]]>
		ORDER BY ID DESC
   </select>
	
	
	<sql id="resultColumn">
		id,app_entrance,app_package,details,download_count,end_time,
		keywords,icon,name,point1,point2,point3,point4,point5,product,package_size,start_time,operate_type,
		deal_status,synopsis,target,type_id,url,version,version_info,branch_id,channels,
		share_count,operator_id,reviewer_id,submit_date,review_date,run_status
	</sql>
	
	<sql id="resultColumnNoId">  
        app_entrance,app_package,details,download_count,end_time,
        keywords,icon,name,point1,point2,point3,point4,point5,product,package_size,start_time,operate_type,
         deal_status,synopsis,type_id,url,version,version_info,branch_id,channels,
         share_count,operator_id,reviewer_id,submit_date,review_date,run_status
	</sql> 
	
	<insert id="insertApp" parameterType="_App">
		INSERT INTO llbtmp_app (
		<include refid="resultColumn" />
		)
		values (
		#{id},
		#{appEntrance,jdbcType=VARCHAR},#{appPackage,jdbcType=VARCHAR},#{details,jdbcType=VARCHAR},
		#{downloadCount,jdbcType=VARCHAR},to_date(#{endTime,jdbcType=DATE},'yyyy-mm-dd hh24:mi:ss')
		,#{keywords,jdbcType=VARCHAR},empty_blob(),#{name,jdbcType=VARCHAR},
		#{point1,jdbcType=VARCHAR},#{point2,jdbcType=VARCHAR},#{point3,jdbcType=VARCHAR},#{point4,jdbcType=VARCHAR},
		#{point5,jdbcType=VARCHAR},#{product,jdbcType=VARCHAR},#{packageSize,jdbcType=VARCHAR},
		 to_date(#{startTime,jdbcType=DATE},'yyyy-mm-dd hh24:mi:ss'),
		#{operateType,jdbcType=VARCHAR},#{dealStatus,jdbcType=VARCHAR},
		#{synopsis,jdbcType=VARCHAR},#{target,jdbcType=VARCHAR},#{typeId,jdbcType=NUMERIC},
		#{url,jdbcType=VARCHAR},#{version,jdbcType=VARCHAR},#{versionInfo,jdbcType=VARCHAR},
		#{branchId,jdbcType=VARCHAR},#{channels,jdbcType=NUMERIC},#{shareCount,jdbcType=VARCHAR},
		#{operatorId,jdbcType=NUMERIC},#{reviewerId,jdbcType=NUMERIC},to_date(#{submitDate,jdbcType=DATE},'yyyy-mm-dd hh24:mi:ss'),
		to_date(#{reviewDate,jdbcType=DATE},'yyyy-mm-dd hh24:mi:ss'),#{runStatus,jdbcType=VARCHAR}
		)
	</insert>
	
	
	<insert id="reviewInsertApp" parameterType="java.util.HashMap">
		insert into llbtmp_app(
		<include refid="resultColumn" />
		)
		select 
		#{deleteKey},
		app_entrance,app_package,details,download_count,end_time,
		keywords,icon,name,point1,point2,point3,point4,point5,product,
		package_size,start_time,operate_type,deal_status,synopsis,#{target},
		type_id,url,version,version_info,branch_id,channels,share_count,operator_id,reviewer_id,submit_date,review_date,#{run}
		from llbtmp_app where id=#{oldId}
	
	</insert>
	
	<update id="update_dealStatus">
		 update llbtmp_app set id=#{id}
		 <if test="appEntrance != null and appEntrance != '' ">, app_entrance=#{appEntrance,jdbcType=VARCHAR}</if>
		<if test="appPackage != null and appPackage != ''"> ,app_package=#{appPackage,jdbcType=VARCHAR}</if>
		<if test="details != null and details != '' "> ,details=#{details,jdbcType=VARCHAR}</if>
		<if test="downloadCount != null and downloadCount != '' "> ,download_count=#{downloadCount,jdbcType=VARCHAR}</if>
		<!-- <if test="endTime != null and endTime != '' "> ,end_time=#{endTime,jdbcType=DATE}</if> -->
		<!-- <if test="target != null and target != '' "> ,empty_blob()</if> -->
		<if test="keywords != null and keywords != '' "> ,keywords=#{keywords,jdbcType=VARCHAR}</if>
		<if test="name != null and name != '' "> ,name=#{name,jdbcType=VARCHAR}</if>
		<if test="point1 != null and point1 != '' "> ,point1=#{point1,jdbcType=VARCHAR}</if>
		<if test="point2 != null and point2 != '' "> ,point2=#{point2,jdbcType=VARCHAR}</if>
		<if test="point3 != null and point3 != '' "> ,point3=#{point3,jdbcType=VARCHAR}</if>
		<if test="point4 != null and point4 != '' "> ,point4=#{point4,jdbcType=VARCHAR}</if>
		<if test="point5 != null and point5 != '' "> ,point5=#{point5,jdbcType=VARCHAR}</if>
		<if test="product != null and product != '' "> ,product=#{product,jdbcType=VARCHAR}</if>
		<if test="packageSize != null and packageSize != '' "> ,package_size=#{packageSize,jdbcType=VARCHAR}</if>
		<!-- <if test="startTime != null and startTime != '' "> ,start_time=#{startTime,jdbcType=DATE}</if> -->
		<if test="operateType != null and operateType != '' "> ,operate_type=#{operateType,jdbcType=VARCHAR}</if>
		<if test="dealStatus != null and dealStatus != '' "> ,deal_status=#{dealStatus,jdbcType=VARCHAR}</if>
		<if test="synopsis != null and synopsis != '' "> ,synopsis=#{synopsis,jdbcType=VARCHAR}</if>
		<if test="target != null and target != '' "> ,target=#{target,jdbcType=VARCHAR}</if>
		<if test="typeId != null and typeId != '' "> ,type_id=#{typeId,jdbcType=VARCHAR}</if>
		<if test="url != null and url != '' "> ,url=#{url,jdbcType=VARCHAR}</if>
		<if test="version != null and version != '' "> ,version=#{version,jdbcType=VARCHAR}</if>
		<if test="versionInfo != null and versionInfo != '' "> ,version_info=#{versionInfo,jdbcType=VARCHAR}</if>
		<if test="branchId != null and branchId != '' "> ,branch_id=#{branchId,jdbcType=VARCHAR}</if>
		<if test="channels != null and channels != '' "> ,channels=#{channels,jdbcType=NUMERIC}</if>
		<if test="shareCount != null and shareCount != '' "> ,share_count=#{shareCount,jdbcType=VARCHAR}</if>
		<if test="operatorId != null and operatorId != '' "> ,operator_id=#{operatorId,jdbcType=NUMERIC}</if>
		<if test="reviewerId != null and reviewerId != '' "> ,reviewer_id=#{reviewerId,jdbcType=NUMERIC}</if>
		<!-- <if test="submitDate != null and submitDate != '' "> ,submit_date=#{submitDate,jdbcType=DATE}</if>
		<if test="reviewDate != null and reviewDate != '' "> ,review_date=#{reviewDate,jdbcType=DATE}</if> -->
		<if test="runStatus != null and runStatus != '' "> ,run_status=#{runStatus,jdbcType=VARCHAR}</if>
		where id = #{id}
		
	</update>  
	 
	 
	 <!-- <update id="update_appssssssssssss">
	  
		INSERT INTO llbtmp_app (
		<include refid="resultColumn" />
		)
		values (
		#{id,jdbcType=NUMERIC},
		#{appEntrance,jdbcType=VARCHAR},#{appPackage,jdbcType=VARCHAR},#{details,jdbcType=VARCHAR},
		#{downloadCount,jdbcType=VARCHAR},#{endTime,jdbcType=DATE},#{keywords,jdbcType=NUMERIC},#{icon,jdbcType=BLOB},#{name,jdbcType=VARCHAR},
		#{point1,jdbcType=VARCHAR},#{point2,jdbcType=VARCHAR},#{point3,jdbcType=VARCHAR},#{point4,jdbcType=VARCHAR},
		#{point5,jdbcType=VARCHAR},#{product,jdbcType=VARCHAR},#{packageSize,jdbcType=VARCHAR},
		#{startTime,jdbcType=DATE},
		#{operateType,jdbcType=VARCHAR},#{dealStatus,jdbcType=VARCHAR},
		#{synopsis,jdbcType=VARCHAR},#{target,jdbcType=VARCHAR},#{typeId,jdbcType=NUMERIC},
		#{url,jdbcType=VARCHAR},#{version,jdbcType=VARCHAR},#{versionInfo,jdbcType=VARCHAR},
		#{branchId,jdbcType=VARCHAR},#{channels,jdbcType=NUMERIC},#{shareCount,jdbcType=VARCHAR},
		#{operatorId,jdbcType=NUMERIC},#{reviewerId,jdbcType=NUMERIC},#{submitDate,jdbcType=DATE},
		#{reviewDate,jdbcType=DATE}) 
		
		
		<if test="appEntrance != null and appEntrance != '' ">, app_entrance=#{appEntrance,jdbcType=VARCHAR}</if>
		<if test="appPackage != null and appPackage != ''"> ,app_package=#{appPackage,jdbcType=VARCHAR}</if>
		<if test="details != null and details != '' "> ,details=#{details,jdbcType=VARCHAR}</if>
		<if test="downloadCount != null and downloadCount != '' "> ,download_count=#{downloadCount,jdbcType=VARCHAR}</if>
		<if test="endTime != null and endTime != '' "> ,end_time=#{endTime,jdbcType=DATE}</if>
		<if test="keywords != null and keywords != '' "> ,keywords=#{keywords,jdbcType=NUMERIC}</if>
		<if test="name != null and name != '' "> ,name=#{name,jdbcType=VARCHAR}</if>
		<if test="point1 != null and point1 != '' "> ,point1=#{point1,jdbcType=VARCHAR}</if>
		<if test="point2 != null and point2 != '' "> ,point2=#{point2,jdbcType=VARCHAR}</if>
		<if test="point3 != null and point3 != '' "> ,point3=#{point3,jdbcType=VARCHAR}</if>
		<if test="point4 != null and point4 != '' "> ,point4=#{point4,jdbcType=VARCHAR}</if>
		<if test="point5 != null and point5 != '' "> ,point5=#{point5,jdbcType=VARCHAR}</if>
		<if test="product != null and product != '' "> ,product=#{product,jdbcType=VARCHAR}</if>
		<if test="packageSize != null and packageSize != '' "> ,package_size=#{packageSize,jdbcType=VARCHAR}</if>
		<if test="startTime != null and startTime != '' "> ,start_time=#{startTime,jdbcType=DATE}</if>
		<if test="operateType != null and operateType != '' "> ,operate_type=#{operateType,jdbcType=VARCHAR}</if>
		<if test="dealStatus != null and dealStatus != '' "> ,deal_status=#{dealStatus,jdbcType=VARCHAR}</if>
		<if test="synopsis != null and synopsis != '' "> ,synopsis=#{synopsis,jdbcType=VARCHAR}</if>
		<if test="target != null and target != '' "> ,target=#{target,jdbcType=VARCHAR}</if>
		<if test="typeId != null and typeId != '' "> ,type_id=#{typeId,jdbcType=VARCHAR}</if>
		<if test="url != null and url != '' "> ,url=#{url,jdbcType=VARCHAR}</if>
		<if test="version != null and version != '' "> ,version=#{version,jdbcType=VARCHAR}</if>
		<if test="versionInfo != null and versionInfo != '' "> ,version_info=#{versionInfo,jdbcType=VARCHAR}</if>
		<if test="branchId != null and branchId != '' "> ,branch_id=#{branchId,jdbcType=VARCHAR}</if>
		<if test="channels != null and channels != '' "> ,channels=#{channels,jdbcType=NUMERIC}</if>
		<if test="shareCount != null and shareCount != '' "> ,share_count=#{shareCount,jdbcType=VARCHAR}</if>
		<if test="operatorId != null and operatorId != '' "> ,operator_id=#{operatorId,jdbcType=NUMERIC}</if>
		<if test="reviewerId != null and reviewerId != '' "> ,reviewer_id=#{reviewerId,jdbcType=NUMERIC}</if>
		<if test="submitDate != null and submitDate != '' "> ,submit_date=#{submitDate,jdbcType=DATE}</if>
		<if test="reviewDate != null and reviewDate != '' "> ,review_date=#{reviewDate,jdbcType=DATE}</if>
		<if test="runStatus != null and runStatus != '' "> ,run_status=#{runStatus,jdbcType=VARCHAR}</if>
	</update>   -->


	<select id="selectList2" parameterType="java.util.HashMap" resultMap="appMap">
		select * from llbtmp_app where type_id = #{typeId} and channels =
		#{channels} and deal_status = #{dealstatus} and run_status is null order by id desc
	</select>

	<select id="getCurrval" resultType="long">
		select LLBTMP_APP_SEQ.currval from dual
	</select>

	<delete id="deleteApp" parameterType="java.util.HashMap">
		 delete from llbtmp_app where id in( #{oldId}, (select id from llbtmp_app a where a.target = #{newId}) )
	</delete>

	
	<!-- 
	<select id="getIcon" resultMap="appPicMap" parameterType="long">
		select * from llbtmp_app where id = #{id}
	</select>
 -->

	<select id="byName" resultMap="appMap" parameterType="long">
		select * from llbtmp_app where
		id = #{name}
	</select>
	
	<select id="selectListRun" parameterType="long" resultMap="appMap">
		select * from llbtmp_app a where a.channels = #{channelId} and  a.run_status is null order by id desc
 		
	</select>
	
	<select id="runList" resultMap="appMap">
		select * from llbtmp_app where run_status = #{run} order by id desc
	</select>
	
	<select id="selectList" resultMap="appMap">
		select * from llbtmp_app a
		order by a.id desc
	</select>
	
	<select id="searchApp" parameterType="java.util.HashMap" resultMap="appMap2">
	  select a.ID,a.name,a.product,a.package_size,a.synopsis,a.version,a.version_info
	  from (llbtmp_app a left join LLBTMP_APP_KEYWORD k on a.id=k.APP_ID) left join LLBTMP_APP_BRANCH ab on a.id=ab.APP_ID
	  where ab.BRANCH_ID=#{branchId} 
	  <if test="keywords != null and keywords != '' ">  and (k.keywords like '%'||#{keywords}||'%' ) </if>
	</select>
	
	<select id="getBranchName" parameterType="long" resultMap="appMap">
		select b.branch_name from llbtmp_app a , llbtmp_branch b , llbtmp_app_branch c where b.id = c.branch_id and a.id = c.app_id and a.id = #{id}
	</select>
	
</mapper>